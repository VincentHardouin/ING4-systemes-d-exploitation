#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/shm.h>
#include <sys/wait.h>
#include <time.h>
#define KEY1 4567
#define KEY2 4568
#define KEY3 4569
#define PERMS 0660

void calculInChildProcess(int num1, int num2, int *ptr) {
    if (fork() == 0) {
        sleep(10);
        (*ptr) = num1 + num2;
        exit(0);
    }
    wait(NULL);
}

int main(int argc, char **argv) {
    int id1;
    int id2;
    int id3;

    int *ptr1;
    int *ptr2;
    int *ptr3;

    int a = 2;
    int b = 3;
    int c = 5;
    int d = 2;
    int e = 1;
    int f = 3;

    system("ipcs -m");
    id1 = shmget(KEY1, sizeof(int), IPC_CREAT | PERMS); 
    id2 = shmget(KEY2, sizeof(int), IPC_CREAT | PERMS); 
    id3 = shmget(KEY3, sizeof(int), IPC_CREAT | PERMS); 
    system("ipcs -m");

    ptr1 = (int *) shmat(id1, NULL, 0); 
    ptr2 = (int *) shmat(id2, NULL, 0); 
    ptr3 = (int *) shmat(id3, NULL, 0); 
    *ptr1 = 0;
    *ptr2 = 0;
    *ptr3 = 0;
    
    calculInChildProcess(a, b, ptr1); 
    calculInChildProcess(c, -d, ptr2); 
    calculInChildProcess(e, f, ptr3); 

    wait(NULL);
    wait(NULL);
    wait(NULL);

    int result = (*ptr1) * (*ptr2) + (*ptr3); 

    printf("Value of *ptr1 = %d\n", *ptr1);
    printf("Value of *ptr2 = %d\n", *ptr2);
    printf("Value of *ptr3 = %d\n", *ptr3);
    printf("Result (a+b) * (c-d) + (e + f) = %d \n", result);

    shmctl(id1, IPC_RMID, NULL);
    shmctl(id2, IPC_RMID, NULL);
    shmctl(id3, IPC_RMID, NULL);
}