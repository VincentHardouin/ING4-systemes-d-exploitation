#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>

const int nombre_client = 10;

void client(int n, int *fd) {
    srand(time(NULL) ^ (getpid()<<16));
    close(fd[0]);
    for(;;) {
        if (rand()%100 == 0) {
            printf("client %d envoi un message\n", n);
            // Ecrire dans le pipe
            char msg = 'c';
            write(fd[1], &msg, sizeof(msg));
        }
        
        usleep(100 * 1000);
    }
}

void server(int *fd) {
    printf("Compteur");
    char c;
    int compteur = 0;
    close(fd[1]);
    while(1) {
        read(fd[0], &c, 1);
        compteur++;
        printf("Compteur : %d", compteur);
        sleep(1);
    }
}



int main(void) {
    
    int fd[2];
    if ( pipe(fd) == -1) {
        perror("Error creation du tube");
    }
    
    int pid_compteur = fork();
    if(pid_compteur == 0) {
        server(fd);
    }
    

    int i;
    for(i=0;i<nombre_client;i++) {
        int pid_client = fork();
        if (pid_client==0) {
            client(i, fd);
        }
    }
    
    /* processus pÃ¨re se met en attente de terminaison des processus fils */
    for(i=0;i<nombre_client;i++) {
        wait(NULL);
    }
    
    wait(NULL);
    
    return 0;    
    
}
